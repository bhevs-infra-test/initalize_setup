# jenkins/tasks.yml
---
- name: Jenkins | Create Docker volume
  community.docker.docker_volume:
    name: "{{ jenkins_volume_name }}"
    state: present
  tags:
    - jenkins
    - setup
    - volume

- name: Jenkins | Stop and remove existing Jenkins container (ensuring idempotence)
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    state: absent
  tags:
    - jenkins
    - setup
    - cleanup

- name: Jenkins | Create Docker network
  community.docker.docker_network:
    name: "{{ jenkins_network_name }}"
    driver: bridge
    state: present
  tags:
    - jenkins
    - setup
    - network

- name: Jenkins | Run Jenkins container (using official image)
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    image: "{{ jenkins_image_official }}"
    state: started
    pull: true
    detach: true
    restart_policy: unless-stopped
    ports:
      - "{{ jenkins_host_port }}:8080"
      - "{{ jenkins_host_port_agent }}:50000"
    volumes:
      - "{{ jenkins_volume_name }}:/var/jenkins_home"
    networks:
      - name: "{{ jenkins_network_name }}"
    env:
      TZ: "Asia/Seoul"
  tags:
    - jenkins
    - run
    - container

- name: Jenkins | Check if initial admin password file already exists
  ansible.builtin.stat:
    path: "/var/lib/docker/volumes/{{ jenkins_volume_name }}/_data/secrets/initialAdminPassword"
  register: password_file_status
  tags:
    - jenkins
    - check
    - password_status

- name: Jenkins | Extract initial admin password
  block:
    - name: Wait for the password to be generated and path to appear in logs
      ansible.builtin.shell:
        cmd: "docker logs {{ jenkins_container_name }} 2>&1 | grep -o '/var/jenkins_home/secrets/initialAdminPassword' -m 1"
      register: password_path_result
      until: password_path_result.stdout != ""
      retries: 20
      delay: 5
      changed_when: false

    - name: Fetch the actual password
      ansible.builtin.shell:
        cmd: "docker exec {{ jenkins_container_name }} cat /var/jenkins_home/secrets/initialAdminPassword"
      register: jenkins_password

    - name: Display the Jenkins initial password
      ansible.builtin.debug:
        msg: "Jenkins initial password is: {{ jenkins_password.stdout }}"
  when: password_file_status.stat.exists
  tags:
    - jenkins
    - debug
    - password
