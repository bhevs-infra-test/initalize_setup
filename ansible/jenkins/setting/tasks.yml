---
# jenkins/setting/tasks.yml
- name: Ensure Jenkins plugins are installed
  community.general.jenkins_plugin:
    name: "{{ jenkins_plugins_list }}"
    state: present
    url: "{{ jenkins_url }}"
    url_username: "{{ jenkins_admin_user }}"
    url_password: "{{ jenkins_admin_api_token }}"
    validate_certs: false
    with_dependencies: true
    force: true
    timeout: 120
  register: plugin_install_result
  notify: Restart Jenkins
  tags:
    - jenkins-plugins

- name: Flush handlers to force Jenkins restart NOW
  meta: flush_handlers
  when: plugin_install_result.changed
  tags:
    - jenkins-plugins

- name: Wait for Jenkins to be fully operational after restart
  uri:
    url: "{{ jenkins_url }}/login"
    status_code: 200
    user: "{{ jenkins_admin_user }}"
    password: "{{ jenkins_admin_api_token }}"
    force_basic_auth: true
    validate_certs: false
  register: jenkins_status
  until: jenkins_status.status == 200
  retries: 30
  delay: 10
  when: plugin_install_result.changed
  tags:
    - jenkins-plugins
