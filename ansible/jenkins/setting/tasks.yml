# jenkins/setting/tasks.yml
#
# Contains tasks for Day 2 operations like user and permission management.
# Each block is controlled by a specific tag.
---
- name: "BLOCK: Prepare Jenkins Host"
  become: yes
  tags: jenkins_prepare
  block:
    - name: "Install prerequisite packages (jq, openjdk)"
      apt:
        name: [jq, openjdk-17-jre]
        state: present
        update_cache: yes

    - name: "Download Jenkins CLI"
      get_url:
        url: "{{ jenkins_url }}/jnlpJars/jenkins-cli.jar"
        dest: "{{ cli_dest_path }}"
        validate_certs: no
        owner: "{{ ansible_user | default(lookup('env', 'USER')) }}"
        group: "{{ ansible_user | default(lookup('env', 'USER')) }}"
        mode: '0755'

- name: "BLOCK: Install Jenkins Plugins"
  tags: jenkins_plugins
  block:
    - name: "Install required plugins"
      community.general.jenkins_plugin:
        name: "{{ item }}"
        state: present
        url: "{{ jenkins_url }}"
        user: "{{ jenkins_admin_user }}"
        token: "{{ jenkins_admin_api_token }}"
        validate_certs: no
      loop: "{{ jenkins_plugins }}"
      register: plugin_install_result

    - name: "Restart Jenkins if plugins were changed"
      community.general.jenkins_command:
        command: safe-restart
        url: "{{ jenkins_url }}"
        user: "{{ jenkins_admin_user }}"
        token: "{{ jenkins_admin_api_token }}"
        validate_certs: no
      when: plugin_install_result.changed

- name: "BLOCK: Create Jenkins Roles"
  tags: jenkins_create_roles
  block:
    - name: "Prompt for role details"
      vars_prompt:
        - { name: "project_role_name", prompt: "Enter name for the new project role (e.g., project-a-reader)", private: no }
        - { name: "project_pattern", prompt: "Enter the job pattern for this role (e.g., Project-A-.*)", private: no }

    - name: "Render Groovy script for role creation"
      template:
        src: jenkins/setting/templates/create_roles.groovy.j2
        dest: /tmp/create_roles.groovy

    - name: "Execute role creation via Jenkins CLI"
      shell: >
        java -jar {{ cli_dest_path }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_api_token }}
        groovy = < /tmp/create_roles.groovy -noCertificateCheck
      register: result
    - debug: msg="{{ result.stdout }}"

- name: "BLOCK: Create User with Roles (Interactive)"
  tags: jenkins_create_user_with_roles
  block:
    # --- Part 1: Get User Details ---
    - name: "Prompt for new user details"
      vars_prompt:
        - { name: "new_username", prompt: "Enter the username to create", private: no }
        - { name: "new_password", prompt: "Enter the password for the new user", private: yes }
        - { name: "new_fullname", prompt: "Enter the full name of the user", private: no }
        - { name: "new_email", prompt: "Enter the email address of the user", private: no }

    # --- Part 2: Fetch and Select Roles ---
    - name: "Fetch current list of roles from Jenkins"
      shell: >
        java -jar {{ cli_dest_path }} -s {{ jenkins_url }} -auth {{ jenkins_admin_user }}:{{ jenkins_admin_api_token }}
        groovy = < {{ item }} -noCertificateCheck
      loop:
        - "{{ lookup('file', 'jenkins/setting/templates/get_roles.groovy.j2') }}"
      register: roles_raw
      changed_when: false

    - name: "Extract Global and Project roles into lists"
      set_fact:
        global_roles: "{{ roles_raw.results[0].stdout_lines | select('match', '^GLOBAL:') | map('replace', 'GLOBAL:', '') | list }}"
        project_roles: "{{ roles_raw.results[0].stdout_lines | select('match', '^PROJECT:') | map('replace', 'PROJECT:', '') | list }}"

    - name: "Prompt user to select a Global role by number"
      pause:
        prompt: |
          Select a Global Role to assign (enter 0 for none)
          0. None
          {% for role in global_roles %}
          {{ loop.index }}. {{ role }}
          {% endfor %}
      register: global_choice

    - name: "Prompt user to select a Project role by number"
      pause:
        prompt: |
          Select a Project Role to assign (enter 0 for none)
          0. None
          {% for role in project_roles %}
          {{ loop.index }}. {{ role }}