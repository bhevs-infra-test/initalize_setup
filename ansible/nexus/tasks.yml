# nexus/tasks.yml
---
- name: Nexus | Create Docker volume
  community.docker.docker_volume:
    name: "{{ nexus_volume_name }}"
    state: present
  tags:
    - nexus
    - setup
    - volume

- name: Nexus | Stop and remove existing Nexus container (ensuring idempotence)
  community.docker.docker_container:
    name: "{{ nexus_container_name }}"
    state: absent
  tags:
    - nexus
    - setup
    - cleanup

- name: Nexus | Create Docker network
  community.docker.docker_network:
    name: "{{ nexus_network_name }}"
    driver: bridge
    state: present
  tags:
    - nexus
    - setup
    - network

- name: Nexus | Run Nexus container
  community.docker.docker_container:
    name: "{{ nexus_container_name }}"
    image: "{{ nexus_image }}"
    state: started
    pull: yes
    detach: yes
    restart_policy: unless-stopped
    ports:
      - "{{ nexus_host_port_http }}:8081"
    volumes:
      - "{{ nexus_volume_name }}:/nexus-data"
    networks:
      - name: "{{ nexus_network_name }}"
    env:
      TZ: "Asia/Seoul"
  tags:
    - nexus
    - run
    - container

- name: Nexus | Extract initial admin password
  block:
    - name: Wait for Nexus to be fully started
      ansible.builtin.shell:
        cmd: "docker logs {{ nexus_container_name }} 2>&1 | grep 'Started Sonatype Nexus'"
      register: nexus_start_result
      until: nexus_start_result.stdout != ""
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait a moment for password file to settle
      ansible.builtin.pause:
        seconds: 5

    - name: Fetch the actual password
      ansible.builtin.shell:
        cmd: "docker exec {{ nexus_container_name }} cat /nexus-data/admin.password"
      register: nexus_password

    - name: Display the Nexus initial password
      ansible.builtin.debug:
        msg: "Nexus initial password is: {{ nexus_password.stdout }}"
  tags:
    - nexus
    - debug
    - password