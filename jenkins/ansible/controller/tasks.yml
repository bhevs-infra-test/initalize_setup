# controller/tasks.yml
---
- name: Jenkins | 1. Docker ë³¼ë¥¨ ìƒì„±
  community.docker.docker_volume:
    name: "{{ jenkins_volume_name }}"
    state: present

- name: Jenkins | 2. ê¸°ì¡´ Jenkins ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ë©±ë“±ì„± ë³´ì¥)
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    state: absent

- name: Jenkins | 3. Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©)
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    image: "{{ jenkins_image_official }}" # <- ê³µì‹ ì´ë¯¸ì§€ ë³€ìˆ˜ ì‚¬ìš©
    state: started
    pull: yes # ì´ë¯¸ì§€ê°€ ë¡œì»¬ì— ì—†ì„ ê²½ìš° Docker Hubì—ì„œ ë°›ì•„ì˜¤ë„ë¡ ì„¤ì •
    detach: yes
    restart_policy: unless-stopped
    ports:
      - "{{ jenkins_host_port_http }}:8080"
      - "{{ jenkins_host_port_agent }}:50000"
    volumes:
      - "{{ jenkins_volume_name }}:/var/jenkins_home"

- name: Jenkins | 4. ì´ˆê¸° ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì¶”ì¶œ
  block:
    - name: ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸° ë° ê²½ë¡œ í™•ì¸
      ansible.builtin.shell:
        cmd: "docker logs {{ jenkins_container_name }} 2>&1 | grep -o '/var/jenkins_home/secrets/initialAdminPassword' -m 1"
      register: password_path_result
      until: password_path_result.stdout != ""
      retries: 20
      delay: 5
      changed_when: false

    - name: ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
      ansible.builtin.shell:
        cmd: "docker exec {{ jenkins_container_name }} cat /var/jenkins_home/secrets/initialAdminPassword"
      register: jenkins_password

    - name: ğŸ”‘ Jenkins ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¶œë ¥
      ansible.builtin.debug:
        msg: "Jenkins initial password is: {{ jenkins_password.stdout }}"