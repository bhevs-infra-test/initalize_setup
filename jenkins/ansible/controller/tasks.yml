# controller/tasks.yml
---
- name: Jenkins | 1. Docker ë¹Œë“œë¥¼ ìœ„í•œ ì¤€ë¹„
  block:
    - name: ë¹Œë“œë¥¼ ìœ„í•œ ì„ì‹œ ë””ë ‰í„°ë¦¬ ìƒì„±
      ansible.builtin.file:
        path: "{{ jenkins_build_dir }}"
        state: directory
        mode: '0755'

    - name: ì¸ì¦ì„œ íŒŒì¼ì„ ë¹Œë“œ ë””ë ‰í„°ë¦¬ë¡œ ë³µì‚¬
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ jenkins_build_dir }}/{{ item }}"
      loop:
        - "BHEVS.LOCAL.crt"
        - "eprism-ca.crt"

    - name: Dockerfileì„ í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±
      ansible.builtin.template:
        src: "Dockerfile.j2"
        dest: "{{ jenkins_build_dir }}/Dockerfile"

- name: Jenkins | 2. Docker ë³¼ë¥¨ ìƒì„±
  community.docker.docker_volume:
    name: "{{ jenkins_volume_name }}"
    state: present

- name: Jenkins | 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ
  community.docker.docker_image:
    name: "{{ jenkins_full_image_name }}"
    source: build
    build:
      path: "{{ jenkins_build_dir }}"
    state: present
  # notify: Cleanup build directory <- í•¸ë“¤ëŸ¬ í˜¸ì¶œ ë¶€ë¶„ ì‚­ì œ

- name: Jenkins | 4. ê¸°ì¡´ Jenkins ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±° (ë©±ë“±ì„± ë³´ì¥)
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    state: absent

- name: Jenkins | 5. Jenkins ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  community.docker.docker_container:
    name: "{{ jenkins_container_name }}"
    image: "{{ jenkins_full_image_name }}"
    state: started
    detach: yes
    restart_policy: unless-stopped
    ports:
      - "{{ jenkins_host_port_http }}:8080"
      - "{{ jenkins_host_port_agent }}:50000"
    volumes:
      - "{{ jenkins_volume_name }}:/var/jenkins_home"

- name: Jenkins | 6. ì´ˆê¸° ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì¶”ì¶œ
  block:
    - name: ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸° ë° ì¶”ì¶œ
      ansible.builtin.shell:
        cmd: "docker logs {{ jenkins_container_name }} 2>&1 | grep -o '/var/jenkins_home/secrets/initialAdminPassword' -m 1"
      register: password_path_result
      until: password_path_result.stdout != ""
      retries: 20
      delay: 5
      changed_when: false

    - name: ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
      ansible.builtin.shell:
        cmd: "docker exec {{ jenkins_container_name }} cat /var/jenkins_home/secrets/initialAdminPassword"
      register: jenkins_password

    - name: ğŸ”‘ Jenkins ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¶œë ¥
      ansible.builtin.debug:
        msg: "Jenkins initial password is: {{ jenkins_password.stdout }}"

- name: Jenkins | 7. ë¹Œë“œ ì„ì‹œ ë””ë ‰í„°ë¦¬ ì •ë¦¬
  ansible.builtin.file:
    path: "{{ jenkins_build_dir }}"
    state: absent