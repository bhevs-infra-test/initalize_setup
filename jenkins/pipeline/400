@Library('bhevs-shared-library') _

pipeline {
    agent { label 'windows-server-agent' }

    environment {
        GIT_CREDENTIALS_ID = 'teamforge-choiseu'
        BUILD_OUTPUT_PATH = 'renault_gen3_odc_appl/Renault_Gen3/Appl/MakeBin_RN'
        GIT_BASE_URL = 'https://teamforge.bhevs.co.kr/gerrit'
    }

    stages {
        stage('1. Source Checkout') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    script {
                        echo "Cloning 1. renault_gen3_odc_appl..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_odc_appl"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_odc_appl']]
                        ])

                        echo "Cloning 2. renault_gen3_platform_common..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_common"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_common']]
                        ])

                        echo "Cloning 3. renault_gen3_platform_wlc..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_wlc"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_wlc']]
                        ])

                        echo "Cloning 4. renault_gen3_platform_wlc_inc..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_wlc_inc"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_wlc_inc']]
                        ])
                    }
                }
            }
        }

        stage('2. Build Execution') {
            steps {
                echo 'Running build_Appl.bat'

                dir('renault_gen3_odc_appl/Renault_Gen3/Appl') {
                    bat 'build_Appl.bat'
                }

                echo 'Running [OneBin]RN_SW_Image_Maker.bat'

                withCredentials([usernamePassword(credentialsId: 'sign-script-credentials', usernameVariable: 'USR', passwordVariable: 'PWD')]) {
                    withEnv(["ID=${USR}", "PW=${PWD}"]) {
                        dir("${env.BUILD_OUTPUT_PATH}") {
                            bat '"[OneBin]RN_SW_Image_Maker.bat"'
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                sendCiNotification(buildStatus: currentBuild.currentResult, payload: env)
            }
        }
    }
}
