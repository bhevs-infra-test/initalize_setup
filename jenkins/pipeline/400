pipeline {
    agent { label 'windows-server-agent' }

    environment {
        GIT_CREDENTIALS_ID = 'teamforge-choiseu'
        BUILD_OUTPUT_PATH = 'renault_gen3_odc_appl/Renault_Gen3/Appl/MakeBin_RN'
        GIT_BASE_URL = 'https://teamforge.bhevs.co.kr/gerrit'

        // NAS PATH SETTING
        NAS_TARGET_PATH = '\\\\your-nas-server\\share\\builds\\${env.BUILD_NUMBER}'
    }

    stages {
        stage('1. Source Checkout') {
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    script {
                        echo "Cloning 1. renault_gen3_odc_appl..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_odc_appl"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_odc_appl']]
                        ])

                        echo "Cloning 2. renault_gen3_platform_common..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_common"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_common']]
                        ])

                        echo "Cloning 3. renault_gen3_platform_wlc..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_wlc"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_wlc']]
                        ])

                        echo "Cloning 4. renault_gen3_platform_wlc_inc..."
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: 'renault_gen3_SWEET400_release']],
                            userRemoteConfigs: [[
                                credentialsId: env.GIT_CREDENTIALS_ID,
                                url: "${env.GIT_BASE_URL}/renault_gen3_platform_wlc_inc"
                            ]],
                            extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'renault_gen3_platform_wlc_inc']]
                        ])
                    }
                }
            }
        }

        stage('2. Build Execution') {
            steps {
                echo 'Running build_Appl.bat'

                dir('renault_gen3_odc_appl/Renault_Gen3/Appl') {
                    bat 'build_Appl.bat'
                }

                echo 'Running [OneBin]RN_SW_Image_Maker.bat'

                dir("${env.BUILD_OUTPUT_PATH}") {
                    bat '"[OneBin]RN_SW_Image_Maker.bat"'
                }
            }
        }

        stage('4. Artifact Transfer (to NAS)') {
            steps {
                // NAS로 전송 예정 경로 표시
                echo "Transferring artifacts from ${env.BUILD_OUTPUT_PATH} to NAS: ${env.NAS_TARGET_PATH}"

                // 빌드 산출물 폴더의 디렉토리 목록 출력
                echo 'Build Output Directory Listing (Contents of MakeBin_RN):'
                dir("${env.BUILD_OUTPUT_PATH}") {
                    bat 'dir'
                }

                // NAS 전송 명령 (주석 처리 유지)
                //bat "robocopy \"${env.BUILD_OUTPUT_PATH}\" \"${env.NAS_TARGET_PATH}\" /E /NP /Z"

                echo 'Artifact transfer completed.'
            }
        }
    }
}
